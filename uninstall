#!/bin/bash

# Pyrodactyl Uninstaller with Custom Banner

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Clear screen
clear

# Your Custom ASCII Banner
echo -e "${RED}"
echo "  _      ____  _____  _____ _   _   _____  _           __     ________"
echo " | |    / __ \|  __ \|_   _| \ | | |  __ \| |        /\\ \\   / /___  /"
echo " | |   | |  | | |__) | | | |  \| | | |__) | |       /  \\ \\_/ /   / / "
echo " | |   | |  | |  _  /  | | | . \` | |  ___/| |      / /\ \\   /   / /  "
echo " | |___| |__| | | \ \ _| |_| |\  | | |    | |____ / ____ \| |   / /__ "
echo " |______\____/|_|  \_\_____|_| \_| |_|    |______/_/    \_\_|  /_____|"
echo -e "${NC}"
echo -e "${RED}            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${RED}            â•‘     UNINSTALLER - REMOVE TOOL      â•‘${NC}"
echo -e "${RED}            â•‘    Made By: Lorinplayz.dev         â•‘${NC}"
echo -e "${RED}            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Warning message
echo -e "${YELLOW}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${YELLOW}â•‘                     âš ï¸  WARNING  âš ï¸                      â•‘${NC}"
echo -e "${YELLOW}â•‘  This will COMPLETELY REMOVE Pyrodactyl from your system â•‘${NC}"
echo -e "${YELLOW}â•‘  - All containers will be deleted                        â•‘${NC}"
echo -e "${YELLOW}â•‘  - All databases will be wiped                           â•‘${NC}"
echo -e "${YELLOW}â•‘  - All game servers will be lost                         â•‘${NC}"
echo -e "${YELLOW}â•‘  - All configurations will be removed                    â•‘${NC}"
echo -e "${YELLOW}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Confirmation with countdown
read -p "$(echo -e ${RED}"Are you ABSOLUTELY SURE you want to uninstall? (yes/no): "${NC})" confirmation

if [[ ! $confirmation == "yes" ]]; then
    echo -e "${GREEN}âœ… Uninstall cancelled. Your Pyrodactyl installation is safe.${NC}"
    exit 0
fi

# Second confirmation
echo ""
echo -e "${RED}âš ï¸  FINAL WARNING: This action cannot be undone! âš ï¸${NC}"
read -p "$(echo -e ${YELLOW}"Type 'DELETE EVERYTHING' to confirm: "${NC})" final_confirm

if [[ ! $final_confirm == "DELETE EVERYTHING" ]]; then
    echo -e "${GREEN}âœ… Uninstall cancelled. Your Pyrodactyl installation is safe.${NC}"
    exit 0
fi

# Progress bar function
progress_bar() {
    local duration=$1
    local steps=20
    for ((i=0; i<=steps; i++)); do
        local percentage=$((i * 100 / steps))
        local filled=$((i * 40 / steps))
        local empty=$((40 - filled))
        printf "\r[%-${filled}s%${empty}s] %d%%" "â–“" "" "$percentage"
        sleep "$duration"
    done
    echo ""
}

echo ""
echo -e "${CYAN}ğŸ”§ Starting uninstallation process...${NC}"
echo ""

# Step 1: Stop and remove containers
echo -e "${YELLOW}[1/5] Stopping and removing Pyrodactyl containers...${NC}"
cd ~/pyrodactyl-panel 2>/dev/null || cd ~/pterodactyl-panel 2>/dev/null || true

# Try different methods to stop containers
sudo docker compose down -v 2>/dev/null
sudo docker-compose down -v 2>/dev/null
docker compose down -v 2>/dev/null
docker-compose down -v 2>/dev/null
progress_bar 0.05

# Step 2: Remove containers
echo -e "${YELLOW}[2/5] Removing Pyrodactyl containers...${NC}"
CONTAINERS=$(sudo docker ps -a | grep -E 'pyrodactyl|pterodactyl|panel|wings|elytra' | awk '{print $1}')
if [[ ! -z "$CONTAINERS" ]]; then
    sudo docker rm -f $CONTAINERS 2>/dev/null
fi
progress_bar 0.05

# Step 3: Remove images
echo -e "${YELLOW}[3/5] Removing Pyrodactyl images...${NC}"
IMAGES=$(sudo docker images | grep -E 'pyrodactyl|pterodactyl|panel|wings|elytra' | awk '{print $3}')
if [[ ! -z "$IMAGES" ]]; then
    sudo docker rmi -f $IMAGES 2>/dev/null
fi
progress_bar 0.05

# Step 4: Remove volumes
echo -e "${YELLOW}[4/5] Removing Pyrodactyl volumes...${NC}"
VOLUMES=$(sudo docker volume ls | grep -E 'pyrodactyl|pterodactyl|panel' | awk '{print $2}')
if [[ ! -z "$VOLUMES" ]]; then
    sudo docker volume rm $VOLUMES 2>/dev/null
fi
progress_bar 0.05

# Step 5: Remove directories
echo -e "${YELLOW}[5/5] Removing Pyrodactyl directories...${NC}"
sudo rm -rf ~/pyrodactyl-panel
sudo rm -rf ~/pterodactyl-panel
sudo rm -rf /etc/pterodactyl
sudo rm -rf /var/lib/pterodactyl
sudo rm -rf /var/log/pterodactyl
progress_bar 0.1

echo ""
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${GREEN}â•‘     âœ… UNINSTALL COMPLETED SUCCESSFULLY    â•‘${NC}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Optional: Remove Docker
echo -e "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${PURPLE}              OPTIONAL: REMOVE DOCKER?${NC}"
echo -e "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
read -p "$(echo -e ${YELLOW}"Do you want to completely remove Docker as well? (y/n): "${NC})" -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${YELLOW}Removing Docker...${NC}"
    
    # Stop Docker
    sudo systemctl stop docker
    sudo systemctl disable docker
    
    # Remove Docker packages
    sudo apt remove -y docker docker-engine docker.io containerd runc docker-ce docker-ce-cli docker-compose-plugin
    sudo apt purge -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
    sudo apt autoremove -y
    
    # Remove Docker directories
    sudo rm -rf /var/lib/docker
    sudo rm -rf /var/lib/containerd
    sudo rm -rf /etc/docker
    sudo rm -f /etc/apt/sources.list.d/docker.list
    sudo rm -f /usr/share/keyrings/docker-archive-keyring.gpg
    
    echo -e "${GREEN}âœ… Docker has been completely removed!${NC}"
fi

# Final banner
echo ""
echo -e "${CYAN}  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${CYAN}  â•‘     Thank you for using Pyrodactyl! Come back soon!    â•‘${NC}"
echo -e "${CYAN}  â•‘        Made With â¤ï¸  By: Lorinplayz.dev                 â•‘${NC}"
echo -e "${CYAN}  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Show system status
echo -e "${BLUE}System cleanup completed. Remaining Docker status:${NC}"
sudo docker ps -a 2>/dev/null | head -n 5 || echo "Docker is no longer available"
echo ""
echo -e "${GREEN}âœ… Pyrodactyl has been completely removed from your system!${NC}"
